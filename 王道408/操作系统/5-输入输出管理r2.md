# 第五章 输入/输出管理

## 目录
- [第五章 输入/输出管理](#第五章-输入输出管理)
  - [目录](#目录)
- [5.0 错题速览](#50-错题速览)
- [5.1 I/O管理概述](#51-io管理概述)
  - [5.1.1 I/O设备](#511-io设备)
    - [按使用特性分类](#按使用特性分类)
    - [传输速率分类](#传输速率分类)
    - [交换单位分类](#交换单位分类)
    - [IO控制器](#io控制器)
  - [5.1.2 I/O控制方式](#512-io控制方式)
    - [程序直接控制方式](#程序直接控制方式)
    - [中断驱动方式](#中断驱动方式)
    - [DMA方式](#dma方式)
    - [通道控制方式](#通道控制方式)
    - [总结](#总结)
  - [5.1.3 I/O软件层次结构](#513-io软件层次结构)
    - [用户层软件](#用户层软件)
    - [设备独立性软件](#设备独立性软件)
    - [设备驱动程序](#设备驱动程序)
    - [中断处理程序](#中断处理程序)
    - [总结](#总结-1)
  - [5.1.4 应用程序I/O接口](#514-应用程序io接口)
    - [输入输出应用程序接口](#输入输出应用程序接口)
    - [阻塞/非阻塞IO](#阻塞非阻塞io)
    - [设备驱动程序接口](#设备驱动程序接口)
  - [整理](#整理)
    - [虚拟设备](#虚拟设备)
    - [I/O逻辑](#io逻辑)
    - [DMA过程](#dma过程)
    - [设备分配](#设备分配)
    - [驱动程序](#驱动程序)
    - [中断处理程序](#中断处理程序-1)

# 5.0 错题速览

# 5.1 I/O管理概述

## 5.1.1 I/O设备

可以将数据输入到计算机，或可以接收计算机输出数据的外部设备

- UNIX将外部设备抽象成特殊文件，用户可以用与文件操作相同的方式对外部设备进行操作（/dev/null）

### 按使用特性分类

人机交互类 —— 数据传输慢

存储设备 —— 快

网络通信 —— 中

### 传输速率分类

低速设备

中速设备

高速设备

### 交换单位分类

块设备：速率高，可寻址，随机读写

字符设备：速率慢，不可寻址，常用中断驱动

### IO控制器

I/O设备由机械部件和电子部件组成

- 机械部件执行具体I/O操作
- 电子部件——I/O控制器
  - 中介作用
    - 接受和识别CPU发出的命令
      - I/O控制器中有相应控制寄存器，存放命令和参数
    - 向CPU报告设备的状态
      - I/O控制器中也有相应的状态寄存器，记录I/O设备的当前状态，1表示空闲，0表示忙碌etc.
    - 数据交换
      - 数据寄存器，暂存CPU发来的数据/暂存设备发来的数据
    - 地址识别
      - 区分控制器中各个寄存器，需要给各个寄存器设置一个特定的“地址”，I/O控制器识别地址并寻到对应寄存器
  - 设备控制器

I/O控制器的组成

- CPU与控制器接口
- I/O逻辑：接受识别各种CPU命令（地址译码），负责对设备发出命令
- 控制器与设备接口

控制过程

![IO控制器](./5-pic/IO控制器.png)

- 一个I/O控制器可能对应多个设备
- 数据、控制器、状态寄存器可能有多个，且这些寄存器都要有相应地址，才能方便CPU操作
  - 内存映射I/O
  - 寄存器独立编址

![IO寄存器编址](./5-pic/IO寄存器编址.png)

## 5.1.2 I/O控制方式

读写流程

CPU干预频率

数据传送单位

数据流向

主要缺点主要优点

### 程序直接控制方式

轮询

![程序直接控制](./5-pic/程序直接控制.png)

### 中断驱动方式

中断机制，阻塞等待I/O的进程，CPU检测中断信号，执行中断处理程序恢复I/O进程（或其他）并继续执行

1. CPU每个指令周期末尾检查中断
2. 中断频率太高，会降低性能
3. 并行

![中断驱动方式](./5-pic/中断驱动方式.png)

### DMA方式

直接存储器存取，块设备I/O控制

1. 单位是块
2. 流向是设备直接到内存，或内存直接到设备
3. 仅一个/多个数据块开始和结束时才需要CPU干预
   - 整块数据传输完成时发出中断信号

DMA控制器

![DMA控制器](./5-pic/DMA控制器.png)

总结

![DMA方式](./5-pic/DMA方式.png)

### 通道控制方式

通道：一种硬件，弱鸡CPU，识别并执行一系列通道指令，需和CPU共享主机内存

1. CPU指明通道程序在内存中位置，指明操作的I/O设备，CPU就切换到其他进程执行
2. 通道执行内存中通道程序（任务清单），指明数据多少，数据存放位置等信息
3. 通道完成任务后，向CPU发出中断信号

![通道控制方式](./5-pic/通道控制方式.png)

### 总结

![总结](./5-pic/IO控制方式总结.png)

## 5.1.3 I/O软件层次结构

![IO层次结构](./5-pic/IO.png)

### 用户层软件

![用户层IO](./5-pic/用户层IO.png)

### 设备独立性软件

设备无关性

1. 向上提供
2. 设备保护
3. 差错处理：对设备错误进行处理
4. 设备分配回收
5. 数据缓冲区管理
6. 逻辑设备名 -> 物理设备名；并根据设备类型调用相应驱动程序

逻辑设备表LUT（有点像单级、两级目录）

- 表项：（逻辑设备名，物理设备名，驱动程序入口地址）

- 法一：整个用户一张LUT
- 法二：每个用户一张LUT

### 设备驱动程序

完成对设备具体控制

以独立进程方式存在

### 中断处理程序

根据中断信号类型找到中断处理程序并执行

![中断处理程序](./5-pic/中断处理程序.png)

### 总结

![IO层次结构](./5-pic/IO层次结构总结.png)

## 5.1.4 应用程序I/O接口

- 输入输出应用程序接口
  - 字符设备接口
  - 块设备接口
  - 网络设备接口
  - 什么是阻塞/非阻塞IO
- 设备驱动程序接口

### 输入输出应用程序接口

无法通过一个统一系统调用接口完成所有类型设备的I/O

- 有的可寻址有的不可以
- 所以会分三类

![输入输出应用程序接口](./5-pic/用户层IO接口.png)

### 阻塞/非阻塞IO

阻塞：发出IO系统调用，进程需阻塞态等待

- 字符设备接口——如从键盘读一个字符get

非阻塞：发出IO系统调用，系统调用可迅速返回，进程无需阻塞等待

- 块设备接口——往磁盘写数据write
- 交给内核完成即可

### 设备驱动程序接口

OS规定设备驱动程序接口标准，各厂商需按要求开发设备驱动程序

## 整理

### 虚拟设备

克服独占设备速度慢、利用率低的特点

一台物理 -> 若干逻辑

### I/O逻辑

I/O逻辑即设备控制器，实现对设备控制

另外两端都是接口

### DMA过程

- 预处理前，请求I/O的进程通过系统调用进入内核态，引起预处理前后都在内核态
- 负责预处理的进程时请求I/O的进程；后处理的是中断服务例程
  - 预处理时请求I/O的进程处于运行态；后处理处于阻塞态
- 开始与结束都需要CPU的参与

### 设备分配

考虑：

- 设备固有属性
- 设备安全性
- 设备独立性

及时性是OS与用户程序需要考虑的

### 驱动程序

一种多个设备只需要一个驱动程序

### 中断处理程序

不同的设备，有不同的中断处理程序
