# 第六章 应用层

## 目录
- [第六章 应用层](#第六章-应用层)
  - [目录](#目录)
- [6.1 网络应用模型](#61-网络应用模型)
  - [6.1.1 客户/服务器模型](#611-客户服务器模型)
  - [6.1.2 P2P模型](#612-p2p模型)
- [6.2 域名系统](#62-域名系统)
  - [6.2.1 层次域名空间](#621-层次域名空间)
  - [6.2.2 域名服务器](#622-域名服务器)
    - [根域名服务器](#根域名服务器)
    - [顶级域名服务器](#顶级域名服务器)
    - [权限域名服务器（授权域名服务器）](#权限域名服务器授权域名服务器)
    - [本地域名服务器](#本地域名服务器)
  - [6.2.3 域名解析过程](#623-域名解析过程)
    - [域名解析](#域名解析)
    - [递归查询DNS的工作原理](#递归查询dns的工作原理)
    - [迭代查询工作原理](#迭代查询工作原理)
  - [考点及易错点](#考点及易错点)
- [6.3 文件传输协议](#63-文件传输协议)
  - [6.3.1 FTP的工作原理](#631-ftp的工作原理)
    - [概念及作用](#概念及作用)
    - [工作方式](#工作方式)
  - [6.3.2 控制连接与数据连接](#632-控制连接与数据连接)
    - [控制连接](#控制连接)
    - [数据连接](#数据连接)

# 6.1 网络应用模型

## 6.1.1 客户/服务器模型

- 服务器：总是打开的主机，服务于许多来自其他客户机的主机请求
- 工作流程
  1. 服务器处于接收请求的状态
  2. 客户机发出服务请求，并等待接收结果
  3. 服务器收到请求，分析请求，进行必要的处理，得到结果并发送给客户机
- 最主要的特征：客户是服务请求方，服务器是服务提供方
- 常见应用：Web、FTP、远程登录和电子邮件等
- 主要特点：
  - 各计算机地位不平等，整个网络的管理工作由少数服务器负责，网络的管理非常集中和方便
  - 客户机相互之间不直接通信
  - 可扩展性不佳 —— 受服务器硬件和网络带宽限制，服务器支持的客户机数量有限

## 6.1.2 P2P模型

- 思想：整个网络中的传输内容不再被保存在中心服务器上，每个结点都同时具有下载、上传的功能，其权利和义务大体对等
- 对等方（Peer），直接相互通信
- 主要优点
  - 减轻服务器计算压力，消除对某个服务器的完全依赖，可以将任务分配到各个节点上，大大提高系统效率和资源利用率
  - 多个客户机直接可以直接共享
  - 可扩展性好
  - 网络健壮性强，单个节点失效不会影响其他部分的节点
- 缺点：
  - 占用较多内存，影响整机速度
  - 对硬盘造成较大损伤
  - 使互联网变得拥塞

# 6.2 域名系统

- 域名系统（Domain Name System，DNS）是因特网使用的命名系统。特定含义主机名 -> 便于机器处理的IP地址

- DNS协议：客户/服务器模型，运行于UDP之上，53号端口
- 概念可分为三部分：
  - 层次域名空间
  - 域名服务器
  - 域名解析器

## 6.2.1 层次域名空间

- 任何一个连接到因特网的主机/路由器，都有一个唯一的层次结构名称，**域名**（Domain Name）
- **域**：是名字空间中一个*可被管理*的划分
  - 域可以划分为子域，子域则可以继续划分，形成顶级域、二级域、三级域etc.
  - 每个域名由**标号序列**组成，各**标号**之间用点(".")隔开
- 注意
  - 标号中英文不区分大小写
  - 标号中除连字符不能使用其他标点符号
  - 每个标号不超过63字符，多标号完整域名不超过255个字符
  - 级别最低域名写左边，级别最高顶级域名写右边
- 顶级域名（Top Level Domain， TLD）分为三类
  - 国家（地区）顶级域名（nTLD）
    - .cn, .us, .uk
  - 通用顶级域名（gTLD）
    - .com, .net, .org, .edu, .gov
  - 基础结构域名（arpa）
    - 用于反向域名解析
- 域名系统中，各级域名由其上一级的域名管理机构管理，顶级域名由因特网名称与数字地址分配机构（ICANN）管理。
  - 国家顶级域名下注册的二级域名均由该国家自行确定
  - 每个组织都可以将它的域再分为一定数量的子域，并将子域委托给其他组织去管理

## 6.2.2 域名服务器

- 域名到IP地址的解析，由运行在**域名服务器**上的程序完成
- 一个服务器管辖（或有权限的）范围称为**区**（小于等于域）
- 每个区设置有相应的**权限域名服务器**，保存该区中所有主机的域名到IP地址的映射
- 每个域名服务器不仅能进行一些解析，还具有连向其他域名服务器的信息 —— 自己不知道时可以去其他地方找。
- 域名服务器按**层次方式**组织

### 根域名服务器

- 最高层次的域名服务器，知道所有的顶级域名服务器的域名和IP地址
- 并不直接将待查询域名直接转换成IP地址，而是告诉**本地域名服务器**下一步应该找哪个顶级域名服务器

### 顶级域名服务器

- 管理在该顶级域名服务器注册的所有二级域名
- 收到DNS查询请求给出相应回答（可能最后结果也可能是下一步查询的域名服务器）

### 权限域名服务器（授权域名服务器）

- 每台主机都必须在权限域名服务器登记
- 许多域名服务器同时充当本地域名服务器和权限域名服务器

### 本地域名服务器

- 本地填写的DNS地址就是本地DNS的地址
- 当一台主机发出DNS查询请求时，这个查询请求报文就发送给该主机的本地域名服务器

## 6.2.3 域名解析过程

### 域名解析

- 含义：域名转化为IP地址的过程，客户端需要域名解析时，通过本机的**DNS客户端**构造一个DNS请求报文，以UDP数据报发送**本地DNS**

- 方式：递归查询和迭代查询
  - 主机向本地域名服务器的查询都采用***递归查询***
  - 本地域名服务器向其他域名服务器采用*递归查询*或*迭代查询*
- **递归查询**：主机询问的本地域名服务器不知道被查询域名的IP地址，则本地域名服务器以**DNS客户**的方式，向根域名服务器继续发出查询请求报文，**而不是让主机自己进行**下一步查询

### 递归查询DNS的工作原理

- 本地域名服务器 -> 根域名服务器，根域名服务器递归向下查询，最后本地域名服务器从根域名服务器得到所需的IP地址
- 给根域名服务器负载过大，实际中几乎不使用

### 迭代查询工作原理

- 主机 -> 本地域名服务器 —— 递归查询
- 本地域名服务器 -> 根域名服务器 —— 迭代查询                                                      
- 根域名服务器收到本地的查询请求时，
  - 要查询的IP地址
  - 或下一步应向哪个顶级域名服务器进行查询
- 然后直到查询完成

## 考点及易错点

- 权限域名服务器：可以将其管辖的主机名转换成主机的IP地址

- 采用迭代查询方式查询`www.abc.xyz.com`，发出DNS查询最多次数是？
  - 本地域名服务器需要迭代地向：
    - 根域名服务器 —— 注意它是给出顶级域名服务器的
    - 顶级域名服务器(.com)
    - 权限域名服务器(.xyz.com)
    - 权限域名服务器(abc.xyz.com)发出查询请求
  - 发出DNS查询请求
- 考：通过超链接请求纯文本Web页
  - 不仅需要考虑DNS请求的RTT
  - 还需要考虑TCP三次握手的RTT —— 在第三次握手报文可以捎带对资源的请求

# 6.3 文件传输协议

## 6.3.1 FTP的工作原理

### 概念及作用

- 文件传输协议（File Transfer Protocol, FTP）
- 提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限
- 功能
  - 提供不同种类主机系统之间（**异构**）的文件传输能力
  - 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力
  - 以匿名FTP的方式提供公用文件共享的能力

### 工作方式

- FTP采用C/S工作方式，使用TCP可靠的传输服务。一个FTP服务器进程可同时为多个客户进程提供服务
- FTP服务器进程两大部分组成
  - 主进程：接收新的请求
  - 若干从属进程：处理单个请求
- 工作步骤
  - 打开熟知端口21，使客户进程能够连接上
  - 等待客户进程发送连接请求
  - 启动从属进程处理客户进程发来的请求，从属进程对请求处理完毕即终止
  - 回到等待状态，继续接收请求
  - 主进程与从属进程是并发执行的
- FTP服务器需要在整个会话期间保留用户的状态信息。特别是服务器必须把执行的用户账户与控制连接联系起来，服务器必须追踪用户在远程目录树上的当前位置

## 6.3.2 控制连接与数据连接

- FTP工作时使用两个并行的TCP连接
  - 控制连接：服务器端口号21
  - 数据连接：服务器端口号20

### 控制连接

- 服务器监听21号端口，等待客户连接，建立在这个端口上的连接称为**控制连接**用来传输控制信息（如连接请求、传送请求等）
- FTP客户发出的传送请求，通过控制连接发送给服务器端中的控制进程
- 控制进程不用来传输文件，传输文件时可以使用控制连接，因此控制连接在**整个会话期间一直保持打开状态**

### 数据连接

- 服务器端控制进程收到FTP客户发送来的文件传输请求后，创建**数据传送进程**和**数据连接**
  - 数据连接：连接客户端和服务器端的数据传送进程
  - 数据传送进程：实际完成文件的传送，传送完毕后关闭”数据传送连接“并结束运行
- 数据连接有两种传输模式：主动模式PORT和被动模式PASV
  - PORT工作原理：
    - 客户端连接到服务器21端口
    - 登录成功后要读取数据，客户端随机开放一个端口，并发送命令告知服务器
    - 服务器收到PORT命令和端口号后，通过20端口和客户端开放的端口连接，发送数据
  - PASV模式不同之处：
    - 客户端要读取数据时，发送PASV命令到服务器
    - 服务器本地随机开放一个端口，告知客户端
    - 客户端再连接到服务器开放的端口进行数据传输
  - **总结**：
    - 主动模式（默认）：服务器连接到客户端的端口
    - 被动模式：客户端连接到服务器的端口
- FTP使用了一个分离的控制连接，所以成FTP的控制信息是带外（Out-of-band）传送的
  - 使用FTP时，要修改服务器上的文件，就需要先将此文件传送到本地主机
  - 然后将修改后的文件副本传送到原服务器，来回传送耗费很多时间
- 网络文件系统（NFS）
  - 允许进程打开一个远程文件，并能在该文件的某个特定位置开始读写数据
  - 这样NFS可以使得用户只复制一个大文件中的一个很小的片段，而不需要复制整个大文件
