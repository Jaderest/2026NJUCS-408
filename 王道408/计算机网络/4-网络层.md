# 第四章 网络层

## 目录
- [第四章 网络层](#第四章-网络层)
  - [目录](#目录)
- [4.1 网络层的功能](#41-网络层的功能)
  - [4.1.1 异构网络互连](#411-异构网络互连)
  - [4.1.2 路由与转发](#412-路由与转发)
  - [4.1.3 网络层提供两种服务](#413-网络层提供两种服务)
    - [虚电路](#虚电路)
    - [数据报](#数据报)
    - [二者比较](#二者比较)
  - [4.1.4 SDN基本概念](#414-sdn基本概念)
    - [基本概念](#基本概念)
    - [SDN接口](#sdn接口)
    - [优点和问题](#优点和问题)
  - [4.1.5 拥塞控制](#415-拥塞控制)
  - [考点\&易错点整理](#考点易错点整理)
- [4.2 IPv4](#42-ipv4)
  - [4.2.1 IPv4分组](#421-ipv4分组)
    - [IPv4分组的格式](#ipv4分组的格式)
    - [IP数据报分片](#ip数据报分片)



# 4.1 网络层的功能

- 网络层提供主机到主机的通信服务，主要任务：将分组从源主机经过多个网络、多段链路传输到目的主机
  - 分组转发
  - 路由选择
- TCP/IP体系结构中，网络层只提供简单灵活的、无连接的、尽最大努力交付的**数据报服务**
  - 传送的分组可能出错、丢失、重复、失序、超时 —— 路由器可以做得很简单，价格低廉
  - 通信可靠性由更高层传输层负责
  - 优点：网络造价大幅降低，运行方式灵活，能适应多种应用

## 4.1.1 异构网络互连

- **互联网**是全球范围内数以百万计的**异构网络**互连起来的 ——由网络层实现这种互联

  - 异构：网络的拓扑结构、寻址方案、差错处理方法、路由选择机制都不尽相同

- **网络互联**：两个以上的计算机网络，通过一定方法，用一些**中继系统**相互连接起来，构成更大网络系统

  - 根据所在层次，中继系统分为4种
    1. 物理层中继系统：转发器、集线器
    2. 数据链路层中继系统：网桥/交换机
    3. 网络层中继系统：路由器
    4. 网络层以上中继系统：网关
  - 网络互联通常指使用**路由器**进行**网络连接和路由选择**
    - 因为使用物理层、数据链路层中继系统连接，只是把网络扩大了，它们在网络层观点仍是同一网络

- TCP/IP在网络互连方面在网络层采用标准化协议，相互连接的网络可以是异构的

  ![IP网络的概念](./4-pic/IP网络的概念.jpg)

  - 参与互连的计算机使用**相同的IP**，通过IP可以使性能各异的网络在网络层上看起来像一个**统一**的网络
  - 可以把互联后的网络视为一个 *虚拟互联网络*，简称IP网络

- 使用IP网：IP网上的主机进行通信时，就好像在单个网络上通信一样，看不见互连的各个网络的具体异构细节（如具体编址方案、路由选择协议等）

## 4.1.2 路由与转发

- **路由选择**：根据路由协议构造**路由表**，同时经常或定期地与相邻路由器交换信息，获取网络最新拓扑，*动态更新维护路由表*，以决定分组到达目的地节点最优路径
- **分组转发**：路由器根据**转发表**将分组从合适的端口转发出去
  - 转发表查询、转发及相关的队列管理任务调度
- 路由表vs转发表
  - 路由表，根据路由算法得出；转发表，从路由表得出
  - 路由表最优化网络拓扑变化的计算；转发表结构应使查找过程最优化
  - 讨论**路由选择原理**时，通常不区分转发表、路由表，统一使用路由表


## 4.1.3 网络层提供两种服务

- **分组交换**网根据通信子网向端点系统提供的服务可分为两种（这两种服务由网络层提供）
  - 面向连接的虚电路服务
  - 无连接的数据报服务
- 补充：对分组交换网的理解
  - 采用分组交换的网络整体 —— 将数据切成分组，通过存储-转发方式在网络中传递
  - **涉及多层**，包括物理层、数据链路层、网络层etc.

### 虚电路

- 虚电路方式中，两台计算机进行通信，应先建立网络层的连接，即建立一条逻辑上的虚电路；连接建立即**固定**虚电路对应的**物理路径**
- 通信过程分为三个阶段
  - 虚电路建立
    - 每次建立时，将一个未用过的**虚电路号**（VCID）分配给该虚电路
  - 数据传输
    - 双方沿已建立的虚电路传送分组
    - 分组首部**仅在建立连接时**使用完整的目的地址，之后每个分组首部只需携带这个虚电路编号即可
  - 虚电路释放
- 虚电路网络中，每个节点维持一张虚电路表，表中每项记录一个打开的虚电路信息
  - 包括虚电路号、前一节点和下一节点的标识
- 特点
  - 通信链路的建立和拆除需要时间开销，对交互式应用和少量段分组情况效率低，但是长时间、频繁数据交换效率高
  - 路由选择 体现在连接建立阶段
  - 提供可靠通信功能，保证每个分组正确有序到达
  - 可对两个端点流量控制
  - 致命弱点：当网络中某节点/链路出现故障彻底失效时，所有经过该节点/链路的虚电路将被破坏
  - 分组首部仅包含虚电路号，相对数据报开销小
  - **虚**：电路并非专用，一个节点可能同时有若干虚电路通过

### 数据报

- 网络发送分组前不需先建立连接。源主机高层协议将报文拆成若干较小数据段，并加上地址等控制信息构成分组
- 中间节点**存储**分组很短一段时间，找到最佳路由后尽快**转发**每个分组
- 举例说明发送过程，主机A向B发送
  - 主机A将分组逐个发往与它直接相连的交换节点A，交换节点缓存收到的分组
  - 交换节点查找自己转发表，不同时刻网络状态不同，转发表内容可能不完全相同，**分组交付的节点可能不同**
  - 其他节点收到分组后，类似地转发分组，直到分组到达主机B
- 数据报服务特点
  - 发送分组前无需建立连接，发送方可随时发送分组，网络中节点可随时接收分组
  - 尽最大努力交付，不保证可靠性（分组出错、丢失）；网络为每个分组独立选择路由，转发路径可能不同，不一定按序到达目的节点
  - 发送分组要包括发送方、接收方完整地址
  - 分组在交换节点存储转发，有时需要排队等候处理，排队时延；会在拥塞时大大增加，交换节点可丢弃部分分组
  - 网络具有冗余路径，故障适应能力较强
  - 收发双方不独占链路，资源利用率较高

### 二者比较

|                    | 数据报服务                                             | 虚电路服务                             |
| ------------------ | ------------------------------------------------------ | -------------------------------------- |
| 连接建立           | 不需                                                   | 需要                                   |
| 目的地址           | 每个分组都有完整目的地址                               | 仅建立连接阶段使用，后续使用VCID       |
| 路由选择           | 每个分组独立路由转发                                   | 同一虚电路的分组按同一路由转发         |
| 分组顺序           | 不保证有序                                             | 有序                                   |
| 可靠性             | 不保证可靠通信，可靠得由用户主机保证                   | 可靠                                   |
| 对网络故障适应     | 出故障节点丢失分组，其他分组路径发生变化时可以正常传输 | 所有经过故障节点的虚电路均不能正常工作 |
| 差错处理、流量控制 | 用户主机流量控制，不保证数据报可靠性                   | 由分组交换网负责，也可由用户主机负责   |



## 4.1.4 SDN基本概念

### 基本概念

- 网络层可抽象地划分为
  - 数据平面（也称转发层面） —— 转发
  - 控制平面 —— 路由选择
- 软件定义网络（Software Defined Network，SDN）是近年流行的一种创新网络架构，采用**集中式的控制平面**和**分布式的数据平面**，两个平面互相分离
  - 控制平面利用*控制-数据接口*对数据平面上路由器进行集中式控制
- SDN结构中，路由器不需要路由选择软件了，路由器也不再相互交换路由信息
  - 控制平面有一个*逻辑上*的**远程控制器**（可由多个服务器组成）
    - 远程控制器：掌握各主机和整个网络状态，为每个分组计算最佳路由；通过Openflow协议（或其他途径）将转发表（SDN中称**流表**）下发给路由器
  - 路由器工作
    - 收到分组
    - 查找转发表
    - 转发分组
  - 这样网络又变成集中控制的，而互联网本来是分布式的
  - 大型数据中心之间的广域网，使用SDN模式建造可以使网络运行效率更高

### SDN接口

- SDN的可编程性，为开发者提供了强大的编程接口
  - 北向接口：SDN提供的编程结构，开发者可以设计自己的应用
  - 南向接口：SDN控制器和转发设备建立双向会话的接口
    - 通过不同的南向接口协议（如Openflow），SDN控制器可以兼容不同的硬件设备，并能在设备中实现上层应用的逻辑
  - 东西向接口：SDN控制器集群内部控制器**之间**的通信接口
    - 用于增强整个控制平面的可靠性可拓展性

### 优点和问题

- 优点
  - 全局集中式控制和分布式高速转发，既利于控制平面的全局优化，又利于高性能的网络转发
  - 灵活可编程与性能的平衡，控制和转发功能分离后，网络可以由专有的自动化工具以编程方式配置
  - 降低成本，实现网络设备制造与功能软件的开发香相分离
- 问题
  - 易受攻击，崩溃则整个网络都会收到影响
  - 瓶颈问题，控制器可能称为网络性能的瓶颈

## 4.1.5 拥塞控制

- 拥塞：因过量的分组而引起网络性能的下降
- 判断方法：观察网络吞吐量与网络负载关系
  - 若随负载增加，网络吞吐量明显小于正常吞吐量，则网络可能已进入轻度拥塞状态
  - 若吞吐量随网络负载增大而减少，则网络可能已进入拥塞状态
- **拥塞控制**：主要解决如何获取网络中发生拥塞的信息，从而利用这些信息控制网络，以避免因拥塞造成的分组丢失
  - 作用：确保网络能承载所达到的流量，是*全局性*的过程
- 拥塞控制vs流量控制
  - 流量控制往往指发送方、接收方间点对点通信量的控制，它要做的是抑制发送方发送速率
- 拥塞控制两种方法
  - **开环控制**，设计网络是，事先考虑有关发生拥塞的因素。**静态的预防方法**，启动后不需再修改
  - 闭环控制，事先不考虑拥塞的因素，采用监测网络监视，及时检测哪里发生拥塞，将拥塞信息传到合适地方调整网络系统的运行，**动态的方法**

## 考点&易错点整理

- 路由器互连的多个局域网结构中，要求每个局域网 物理层、数据链路层、**网络层**协议可以不同，而以上高层协议必须相同
  - 路由器是网络层设备，向传输层及以上隐藏下层的具体实现，物、链、网实现都被隐藏，所以可以不同
  - **网络层**不同举例：使用特定路由器连接IPv4和IPv6
- 存储转发机制：先**接收整个**分组，对分组进行错误检查，正确则转发，错误即丢弃
- 虚电路建立连接时建立的是逻辑连接（并非物理连接）
  - 注意虚电路连接需要主动断开，而不是会话结束就释放连接



# 4.2 IPv4

## 4.2.1 IPv4分组

- IPv4（版本4）：现在普遍使用的**网际协议**（Internet Protocal，IP）
  - 定义数据传送的基本单元 —— IP分组及其确切数据格式
  - 包括一套规则，指明分组如何处理、错误怎样控制

### IPv4分组的格式

<img src="./4-pic/IP数据报的格式.jpg" alt="IP数据报的格式" style="zoom:67%;" />

- 由首部和数据部分组成，首部分两部分，前一部分长度固定，共20B（所有IP分组必须具有的）；后面是一些可选字段，长度可变，提供错误检测和安全等机制

- 首部重要字段含义

  1. 版本，4bit。
     - 指IP版本，IPv4中值为4

  2. 首部长度，4bit。

     - 以4B为单位，例如不使用任何可选字段的首部长度20B，该值为5

     - 最大首部长度是60B，达到最大值15（1111B)

  3. 总长度，16bit。

     - 1B为单位，数据报最大长度为$2^{16}-1=65535B$

     - 而以太网帧最大传送单元（MTU）为1500B

     - IP数据报封装成帧时，总长度一定不能超过下面数据链路层的MTU

  4. **标识**，16bit

     - 计数器，每产生一个数据报就+1，并赋值给标识字段
     - **原始数据报的标识号唯一**，所以组装时能分辨出来
     - 分片时，每个数据报片都复制一次**标识号**，以便能正确重装

  5. 标志（Flag），3bit。

     - 最低位MF，MF = 1表示后面还有分片，MF = 0表示最后一个分片

     - 标志字段中间位位DF，只有DF = 0才允许分片

  6. 片偏移，13bit。

     - 较长数据报在分片后，该片在原数据报中相对位置

     - 8B位单位 -> 除最后一个分片外，每个分片长度**必定**是8B的整数倍

  7. 生存时间（TTL），8bit

     - 可通过路由器数最大值，标识数据报在网络中寿命（确保不会永远在网络中循环）

     - 路由器转发前，TTL减一。若减到0了就不转发丢弃了

  8. 协议，8bit

     - 数据部分上交给哪个协议进行处理

     - 值6 TCP；17 UDP

  9. 首部检验和（checksum），16bit

     - 源地址字段，4B

  10. 发送方**IP地址**

  11. 目的地址字段，4B

### IP数据报分片

- 链路层数据帧能承载最大数据量为 **最大传送单元**（MTU）
  - 以太网MTU = 1500B；许多广域网MTU <= 576B
- MTU严格限制IP数据报的长度 -> 较长IP数据报分装成较小IP数据报，称为**片**
  - 片在目的地网络层会重新组装
  - 目的主机使用IP首部中：标识、标志和片偏移字段完成对片的重组

- 分片&重组中字段分析

  - 分片时，形成的每个数据报（片）都具有原始数据的标识号
  - 目的主机收到来自同一发送主机一批数据报时
    - 可以通过**检查数据报标识号**来确定数据片属于哪些原始数据报
    - 重组时，使用片偏移字段来确定片应放原始IP数据报的哪个位置
  - 标志位只有后两位有意义
    - DF（Don't Fragment）
    - MF（More Fragment）

- 分片计算示例

  ![IP数据报分片计算](./4-pic/4-2IP数据报分片计算.jpg)

## 4.2.2 IPv4地址与NAT
